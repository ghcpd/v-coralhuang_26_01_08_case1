#!/usr/bin/env python3
"""
One-click test runner for mini_humanize.
Automatically installs dependencies if needed and runs the full test suite.
"""
import subprocess
import sys
import os


def check_pytest_installed():
    """Check if pytest is installed."""
    try:
        import pytest
        return True
    except ImportError:
        return False


def install_dependencies():
    """Install test dependencies."""
    print("Installing test dependencies...")
    try:
        subprocess.check_call([
            sys.executable, "-m", "pip", "install", "-q",
            "pytest>=8.0.0", "pytest-cov>=5.0.0"
        ])
        print("Dependencies installed successfully.")
        return True
    except subprocess.CalledProcessError as e:
        print(f"Failed to install dependencies: {e}")
        return False


def run_tests():
    """Run the full test suite with coverage."""
    print("\n" + "="*70)
    print("Running mini_humanize test suite")
    print("="*70 + "\n")
    
    # Run pytest with coverage
    cmd = [
        sys.executable, "-m", "pytest",
        "tests/",
        "-v",
        "--cov=mini_humanize",
        "--cov-report=term-missing",
        "--cov-report=html",
    ]
    
    try:
        result = subprocess.run(cmd, cwd=os.path.dirname(os.path.abspath(__file__)))
        return result.returncode
    except Exception as e:
        print(f"Error running tests: {e}")
        return 1


def main():
    """Main entry point."""
    # Check if pytest is installed
    if not check_pytest_installed():
        print("pytest not found. Installing dependencies...")
        if not install_dependencies():
            print("\nERROR: Could not install dependencies.")
            print("Please manually run: pip install pytest pytest-cov")
            return 1
    
    # Run tests
    return run_tests()


if __name__ == "__main__":
    sys.exit(main())
